#!/usr/bin/env bash
shell_type="$1"

if [[ -n "$shell_type" && "$shell_type" != "bash" && "$shell_type" != "zsh" ]]; then
  echo "Usage: $(basename "$0") <shell_type>"
  echo ""
  echo "Allowed shell types: bash, zsh"
  exit 1
fi

index_names=()

readarray -t names < <(_pbu.persistent_kv list _pbu_persistent_source_data_${shell_type})
for name in "${names[@]}"; do
  index="$(_pbu.persistent_kv get _pbu_persistent_source_index_${shell_type} "$name")"
  index_names+=("$shell_type:$index:$name")
done

IFS=$'\n' sorted_array=($(printf "%s\n" "${index_names[@]}" | sort -t: -k1,1 -k2n,2n -k3,3))

for index_name in "${sorted_array[@]}"; do
  IFS=':' read -r sh index name <<< "$index_name"
  echo "# ${sh} script from: $name"
  _pbu.persistent_kv get _pbu_persistent_source_data_${shell_type} "$name"
  echo ""
done
