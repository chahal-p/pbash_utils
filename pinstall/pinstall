#!/usr/bin/env bash

getopt_args=( -o "q" -l "quiet" -- "$@" )
getopt "${getopt_args[@]}" > /dev/null || exit $?
PARSED_OPTIONS=$(getopt "${getopt_args[@]}")
eval set -- "${PARSED_OPTIONS[@]}"

quiet="false"

while true; do
  case "$1" in
    -q|--quiet)
      quiet="true"
      shift
      ;;
    --)
      shift
      break
      ;;
    *)
      echo "Unexpected option: $1" >&2
      exit 1
      ;;
  esac
done

installation_path="$HOME/.local/bin/"
[ -d $HOME/.local/bin ] || mkdir -p $HOME/.local/bin

default_bash='#!\/usr\/bin\/env\ bash'
evaluated_bash="#!"
evaluated_bash+="$(/usr/bin/env | grep SHELL | tr '=' '\n' | tail -n 1)"
evaluated_bash="${evaluated_bash//\//\\/}"
sed_args=()
[[ "$OSTYPE" == "darwin"* ]] && sed_args+=( "" )
sed_args+=( "s/$default_bash/$evaluated_bash/1" )

for p in "$@"
do
  p="$(realpath "$p")"
  bn="$(basename "$p")"
  if [ -f "$p" ]
  then
    [ "$quiet" == "true" ] || echo "Installing: $bn"
    cp "$p" "${installation_path}${bn}" && chmod +x "${installation_path}${bn}" || { echo "Installation failed"; exit 1; }
  fi
  sed -i "${sed_args[@]}" "${installation_path}${bn}"
done