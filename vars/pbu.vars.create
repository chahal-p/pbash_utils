#!/usr/bin/env bash

parsed=$(pflags parse --description 'Create a command with provided var name, that can be used to get or set the value.

Example: xyz var created.

Set value by passing arg:
  xyz $value

Set value by reading from stdin:
  echo $value | xyz -

Get value:
  xyz' --name pbu.vars.create ---- \
  -l var -t string -r -h 'Name of var' ---- "$@") || exit
pflags printhelp "$parsed" && exit

readarray -t vars <<< "$(pflags get --name var "$parsed")"

for var in ${vars[@]}; do
  pbu.install --name "${var}" --content - <<EOF
#!/usr/bin/env bash
if [ "\${#@}" -eq 0 ]; then
  pbu.persistent_kv.get --namespace _pbu_vars --key "${var}"
else
  if [[ "\$1" == '-' ]]; then
    pbu.persistent_kv.set --namespace _pbu_vars --key "${var}"
  else
    pbu.persistent_kv.set --namespace _pbu_vars --key "${var}" --value "\$1"
  fi
  printf "%s\n" "Value is set in ${var}. Use '${var}' without args to get the value."
fi
EOF
  echo -n | pbu.persistent_kv.set --namespace _pbu_vars --key "${var}"
done
